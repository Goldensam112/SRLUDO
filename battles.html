<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SR LUDO | Battles</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #040913; --card: #0d1b33; --card-2: #102340; --text: #e8efff;
      --muted: #9fb0d1; --line: rgba(255, 255, 255, 0.08); --accent: #2f7bff;
      --accent-2: #18b3ff; --gold-1: #a86b00; --gold-2: #ffd05a; --danger: #ff3d4d;
      --ok: #38d17f; --warn: #ffb34a;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: radial-gradient(1200px 500px at 50% -200px, #154b99 0%, var(--bg) 65%); color: var(--text); }
    .app { max-width: 540px; margin: 0 auto; min-height: 100vh; border-left: 1px solid rgba(255,255,255,.05); border-right: 1px solid rgba(255,255,255,.05); background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); padding-bottom: 86px; }
    .sticky-header { position: sticky; top: 0; z-index: 30; backdrop-filter: blur(10px); background: rgba(4, 9, 19, 0.88); border-bottom: 1px solid var(--line); padding: 12px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .back-btn { border: 1px solid var(--line); background: rgba(255,255,255,.04); color: var(--text); border-radius: 10px; padding: 8px 10px; text-decoration: none; font-size: 13px; white-space: nowrap; }
    .wallets { display: flex; gap: 8px; }
    .pill { min-width: 108px; border-radius: 999px; padding: 7px 11px; font-size: 12px; border: 1px solid rgba(255,255,255,.24); }
    .pill strong { display: block; margin-top: 1px; font-size: 14px; }
    .cash { background: linear-gradient(130deg, #0f49b3, #2a89ff); }
    .winning { background: linear-gradient(130deg, var(--gold-1), var(--gold-2)); color: #1f1711; }
    .content { padding: 14px; }
    .section { margin-top: 14px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .space-between { justify-content: space-between; }
    .online { display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--line); background: rgba(255,255,255,.03); border-radius: 999px; padding: 8px 12px; color: var(--muted); font-size: 12px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--ok); box-shadow: 0 0 10px var(--ok); animation: blink 1.05s infinite; }
    @keyframes blink { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: .35; transform: scale(.8); } }
    .btn { border: 0; border-radius: 12px; padding: 11px 12px; color: #fff; font-weight: 700; cursor: pointer; background: linear-gradient(100deg, var(--accent), var(--accent-2)); }
    .btn-muted { border: 1px solid var(--line); border-radius: 12px; padding: 10px 12px; color: var(--text); background: rgba(255,255,255,.05); cursor: pointer; }
    .btn-gold { background: linear-gradient(130deg, #9b6400, #ffcf57); color: #1f1711; }
    .btn-danger { background: linear-gradient(120deg, #c71c30, #ff3d4d); }
    .btn-win { background: linear-gradient(120deg, #0f8f45, #25cc71); }
    .full { width: 100%; }
    .card { margin-top: 10px; background: linear-gradient(160deg, var(--card), var(--card-2)); border: 1px solid var(--line); border-radius: 16px; padding: 12px; }
    .muted { color: var(--muted); }
    .title { margin: 0; font-size: 17px; }
    .small { font-size: 12px; }
    .input { width: 100%; border: 1px solid var(--line); border-radius: 12px; background: rgba(255,255,255,.03); color: var(--text); padding: 12px; outline: none; }
    .status { display: inline-flex; align-items: center; font-size: 11px; border-radius: 999px; border: 1px solid var(--line); padding: 5px 9px; }
    .st-open { color: var(--warn); } .st-playing { color: #82b9ff; } .st-dispute { color: #ffc978; } .st-completed { color: #7fffbc; }
    .win-highlight { color: #38d17f; font-size: 18px; font-weight: 800; display: block; margin-top: 5px; }
    .room-code { margin-top: 8px; font-size: 30px; letter-spacing: 1px; font-weight: 800; color: #ffd76c; text-align: center; border: 1px dashed rgba(255, 215, 108, 0.6); border-radius: 12px; padding: 8px; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; z-index: 50; }
    .overlay.show { display: block; }
    .modal { position: fixed; z-index: 60; width: min(92%, 460px); left: 50%; top: 50%; transform: translate(-50%, -50%); border: 1px solid var(--line); border-radius: 16px; background: #08162c; padding: 14px; display: none; }
    .modal.show { display: block; }
  </style>
</head>
<body>
  <div class="app">
    <header class="sticky-header">
      <a class="back-btn" href="index.html">← Home</a>
      <div class="wallets">
        <div class="pill cash">Cash<strong id="cashAmount">₹0</strong></div>
        <div class="pill winning">Winning<strong id="winAmount">₹0</strong></div>
      </div>
    </header>

    <main class="content">
      <section class="section row space-between">
        <div class="online"><span class="dot"></span> Online Players: <strong id="onlinePlayers">500+</strong></div>
        <button id="rulesBtn" class="btn-muted" type="button">Rules</button>
      </section>

      <section class="section card">
        <h3 class="title">Create Battle</h3>
        <p class="muted small">Enter amount (multiples of 50). win_balance first, then cash.</p>
        <div class="row">
          <input id="battleAmount" class="input" type="number" min="50" step="50" placeholder="e.g. 100" />
          <button id="createBattleBtn" class="btn" type="button">Create</button>
        </div>
      </section>

      <section class="section"><h3 class="title">Open Battles</h3><div id="openBattles"></div></section>
      <section class="section"><h3 class="title">My Running Battles</h3><div id="runningBattles"></div></section>
    </main>
  </div>

  <div id="overlay" class="overlay"></div>

  <section id="rulesModal" class="modal">
    <h3 class="title">Battle Rules</h3>
    <ul class="muted small">
      <li>2% referral commission credited on completion.</li>
      <li>Exit/Auto-exit rules based on steps.</li>
      <li>Do not cancel on site before exiting Ludo King.</li>
    </ul>
    <button class="btn full" data-close-modal="rulesModal">Close</button>
  </section>

  <section id="winModal" class="modal">
    <h3 class="title">Upload Winning Screenshot</h3>
    <input id="winFile" class="input" type="file" accept="image/*" />
    <div class="row" style="margin-top:10px;">
      <button id="submitWinBtn" class="btn btn-gold full">Submit</button>
      <button class="btn-muted" data-close-modal="winModal">Cancel</button>
    </div>
  </section>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getDatabase, ref, onValue, push, get, set, update, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyAx0fr47IsOtBxakcBj1ndwDYle_XlaE-Y',
      authDomain: 'sr-ludo-4440b.firebaseapp.com',
      databaseURL: 'https://sr-ludo-4440b-default-rtdb.firebaseio.com',
      projectId: 'sr-ludo-4440b',
      storageBucket: 'sr-ludo-4440b.firebasestorage.app',
      messagingSenderId: '1080387235822',
      appId: '1:1080387235822:web:77faea231641837950e8ff'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const IMGBB_API_KEY = 'ca44783bda6779b5e3913432bd243b30';

    let phone = "";
    let myUser = { balance: 0, win_balance: 0 };
    let pendingWinBattleId = null;

    // --- AUTH SECURITY CHECK ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        const prefix = user.email.split('@')[0];
        phone = prefix.length === 10 ? "+91" + prefix : prefix;
        localStorage.setItem('sr_ludo_phone', phone);
        
        ensureUserRecord();
        syncWalletRealtime();
        syncBattlesRealtime();
      } else {
        window.location.href = 'index.html';
      }
    });

    // --- ALL LOGIC FUNCTIONS (PROTECTED) ---
    const fmt = (n = 0) => `₹${Number(n).toLocaleString('en-IN')}`;
    const maskPhone = (ph) => ph ? `SR Player-${ph.toString().slice(-4)}` : 'SR Player';
    const statusClass = (st) => ({ open: 'st-open', playing: 'st-playing', pending: 'st-dispute', dispute: 'st-dispute', completed: 'st-completed' }[st] || '');

    async function ensureUserRecord() {
      const uRef = ref(db, `users/${phone}`);
      const snap = await get(uRef);
      if (!snap.exists()) {
        await set(uRef, { phone, balance: 0, win_balance: 0, referral_balance: 0, kyc_status: 'pending', time: Date.now() });
      }
    }

    async function deductSmartWallet(userPhone, amount) {
      const uRef = ref(db, `users/${userPhone}`);
      let deduction = null;
      await runTransaction(uRef, (u) => {
        if (!u) return u;
        const total = Number(u.win_balance || 0) + Number(u.balance || 0);
        if (total < amount) return;
        const fromWin = Math.min(Number(u.win_balance || 0), amount);
        u.win_balance = Number(u.win_balance || 0) - fromWin;
        u.balance = Number(u.balance || 0) - (amount - fromWin);
        deduction = { fromWin, fromCash: amount - fromWin };
        return u;
      });
      if (!deduction) throw new Error('Insufficient Balance');
      return deduction;
    }

    async function processReferralCommission(winnerPhone, winAmount) {
      const winnerSnap = await get(ref(db, `users/${winnerPhone}`));
      const referrer = winnerSnap.val()?.referredBy;
      if (referrer) {
        const comm = Math.round(winAmount * 0.01053); // ~1% Effective
        if (comm > 0) {
          await runTransaction(ref(db, `users/${referrer}`), (u) => {
            if (u) {
              u.referral_balance = (u.referral_balance || 0) + comm;
              u.referral_earnings_total = (u.referral_earnings_total || 0) + comm;
            }
            return u;
          });
          const hRef = push(ref(db, `referral_payouts/${referrer}`));
          await set(hRef, { fromPlayer: winnerPhone, commissionAmount: comm, gameWin: winAmount, time: Date.now() });
        }
      }
    }

    // --- ACTIONS ---
    window.createBattle = async () => {
      const amt = Number(document.getElementById('battleAmount').value);
      if (amt < 50 || amt % 50 !== 0) return alert('Multiples of 50 only');
      try {
        const deduct = await deductSmartWallet(phone, amt);
        const bRef = push(ref(db, 'battles'));
        const winAmt = amt >= 500 ? Math.round(amt * 2 * 0.97) : Math.round(amt * 1.9);
        await set(bRef, { id: bRef.key, amount: amt, winAmount: winAmt, status: 'open', creatorPhone: phone, creatorDeduct: deduct, createdAt: Date.now(), updatedAt: Date.now() });
        document.getElementById('battleAmount').value = '';
      } catch (e) { alert(e.message); }
    };

    window.joinBattle = async (id) => {
      const bRef = ref(db, `battles/${id}`);
      const snap = await get(bRef);
      const b = snap.val();
      if (b.creatorPhone === phone) return alert("Can't join own battle");
      try {
        const deduct = await deductSmartWallet(phone, b.amount);
        await update(bRef, { status: 'playing', joinerPhone: phone, joinerDeduct: deduct, startedAt: Date.now(), updatedAt: Date.now() });
      } catch (e) { alert(e.message); }
    };

    window.setRC = async (id) => {
      const code = document.getElementById(`rc-${id}`).value;
      if (!code) return alert("Enter Code");
      await update(ref(db, `battles/${id}`), { roomCode: code, updatedAt: Date.now() });
    };

    window.iLost = async (id) => {
      if(!confirm("Declare LOSS?")) return;
      const bRef = ref(db, `battles/${id}`);
      const bSnap = await get(bRef);
      const b = bSnap.val();
      const winner = b.creatorPhone === phone ? b.joinerPhone : b.creatorPhone;
      await update(bRef, { status: 'completed', winnerPhone: winner, loserPhone: phone, settledAt: Date.now() });
      await runTransaction(ref(db, `users/${winner}`), (u) => { if(u) u.win_balance = (u.win_balance || 0) + b.winAmount; return u; });
      await processReferralCommission(winner, b.winAmount);
      alert("Settled!");
    };

    window.iWin = (id) => { pendingWinBattleId = id; document.getElementById('winModal').classList.add('show'); document.getElementById('overlay').classList.add('show'); };

    window.submitWin = async () => {
      const file = document.getElementById('winFile').files[0];
      if(!file) return alert("Upload SS");
      const fd = new FormData(); fd.append('image', file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
      const json = await res.json();
      await update(ref(db, `battles/${pendingWinBattleId}`), { status: 'pending', screenshot_url: json.data.url, win_claim_by: phone, claimedAt: Date.now() });
      document.getElementById('winModal').classList.remove('show');
      document.getElementById('overlay').classList.remove('show');
      alert("Claimed!");
    };

    window.cancelBattle = async (id) => {
      const bRef = ref(db, `battles/${id}`);
      const snap = await get(bRef);
      const b = snap.val();
      const deduct = b.creatorDeduct;
      await update(bRef, { status: 'cancelled' });
      await runTransaction(ref(db, `users/${phone}`), (u) => {
        if(u) {
          u.win_balance = (u.win_balance || 0) + (deduct?.fromWin || 0);
          u.balance = (u.balance || 0) + (deduct?.fromCash || 0);
        }
        return u;
      });
    };

    // --- UI SYNC ---
    function syncWalletRealtime() {
      onValue(ref(db, `users/${phone}`), (snap) => {
        const u = snap.val() || {};
        document.getElementById('cashAmount').textContent = fmt(u.balance || 0);
        document.getElementById('winAmount').textContent = fmt(u.win_balance || 0);
      });
    }

    function syncBattlesRealtime() {
      onValue(ref(db, 'battles'), (snap) => {
        const all = Object.values(snap.val() || {});
        // Open
        const open = all.filter(b => b.status === 'open').sort((a,b) => b.createdAt - a.createdAt);
        document.getElementById('openBattles').innerHTML = open.map(b => `
          <div class="card">
            <div class="row space-between"><strong>₹${b.amount}</strong><span class="status st-open">OPEN</span></div>
            <div class="win-highlight">Win: ${fmt(b.winAmount)}</div>
            <div class="row" style="margin-top:10px;">
              ${b.creatorPhone === phone ? `<button class="btn btn-danger full" onclick="cancelBattle('${b.id}')">Cancel</button>` : `<button class="btn btn-gold full" onclick="joinBattle('${b.id}')">JOIN NOW</button>`}
            </div>
          </div>`).join('') || '<div class="card muted">No battles.</div>';

        // Running
        const run = all.filter(b => [b.creatorPhone, b.joinerPhone].includes(phone) && b.status === 'playing');
        document.getElementById('runningBattles').innerHTML = run.map(b => {
          const isCr = b.creatorPhone === phone;
          return `<div class="card">
            <div class="row space-between"><strong>₹${b.amount}</strong><span class="status st-playing">PLAYING</span></div>
            <div class="small muted">Opponent: ${maskPhone(isCr ? b.joinerPhone : b.creatorPhone)}</div>
            ${isCr && !b.roomCode ? `<div class="row" style="margin-top:8px;"><input class="input" id="rc-${b.id}" placeholder="Room Code"><button class="btn btn-gold" onclick="setRC('${b.id}')">SET</button></div>` : `<div class="room-code">${b.roomCode || "Waiting..."}</div>`}
            <div class="row" style="margin-top:10px;"><button class="btn btn-win full" onclick="iWin('${b.id}')">I WIN</button><button class="btn btn-danger full" onclick="iLost('${b.id}')">I LOST</button></div>
          </div>`;
        }).join('') || '<div class="card muted">No running battles.</div>';
      });
    }

    // Modal Handlers
    document.getElementById('rulesBtn').onclick = () => { document.getElementById('rulesModal').classList.add('show'); document.getElementById('overlay').classList.add('show'); };
    document.getElementById('submitWinBtn').onclick = window.submitWin;
    document.getElementById('createBattleBtn').onclick = window.createBattle;
    document.querySelectorAll('[data-close-modal]').forEach(b => b.onclick = () => { document.getElementById(b.dataset.closeModal).classList.remove('show'); document.getElementById('overlay').classList.remove('show'); });
    onValue(ref(db, 'app_stats/online_players'), (snap) => { document.getElementById('onlinePlayers').textContent = (snap.val() || 500) + '+'; });
  </script>
</body>
</html>
