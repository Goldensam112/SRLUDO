<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SR LUDO | Battles</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #040913;
      --card: #0d1b33;
      --card-2: #102340;
      --text: #e8efff;
      --muted: #9fb0d1;
      --line: rgba(255, 255, 255, 0.08);
      --accent: #2f7bff;
      --accent-2: #18b3ff;
      --gold-1: #a86b00;
      --gold-2: #ffd05a;
      --danger: #ff3d4d;
      --ok: #38d17f;
      --warn: #ffb34a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: radial-gradient(1200px 500px at 50% -200px, #154b99 0%, var(--bg) 65%);
      background-attachment: fixed; /* Fix for background */
      color: var(--text);
    }
    .app {
      max-width: 540px;
      margin: 0 auto;
      min-height: 100vh;
      border-left: 1px solid rgba(255,255,255,.05);
      border-right: 1px solid rgba(255,255,255,.05);
      background: rgba(4, 9, 19, 0.95);
      padding-bottom: 86px;
    }
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 30;
      backdrop-filter: blur(10px);
      background: rgba(4, 9, 19, 0.88);
      border-bottom: 1px solid var(--line);
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .back-btn {
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      text-decoration: none;
      font-size: 13px;
      white-space: nowrap;
    }
    .wallets { display: flex; gap: 8px; }
    .pill {
      min-width: 100px;
      border-radius: 12px;
      padding: 7px 11px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.1);
    }
    .pill strong { display: block; margin-top: 1px; font-size: 14px; }
    .cash { background: linear-gradient(130deg, #0f49b3, #2a89ff); }
    .winning { background: linear-gradient(130deg, var(--gold-1), var(--gold-2)); color: #1f1711; }

    .content { padding: 14px; }
    .section { margin-top: 14px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .space-between { justify-content: space-between; }
    .online {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: 8px 12px;
      color: var(--muted);
      font-size: 12px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--ok);
      box-shadow: 0 0 10px var(--ok);
      animation: blink 1.05s infinite;
    }
    @keyframes blink { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: .35; transform: scale(.8); } }
    
    .btn {
      border: 0;
      border-radius: 12px;
      padding: 11px 12px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(100deg, var(--accent), var(--accent-2));
    }
    .btn-muted {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--text);
      background: rgba(255,255,255,.05);
      cursor: pointer;
    }
    .btn-gold { background: linear-gradient(130deg, #9b6400, #ffcf57); color: #1f1711; }
    .btn-danger { background: linear-gradient(120deg, #c71c30, #ff3d4d); }
    .btn-win { background: linear-gradient(120deg, #0f8f45, #25cc71); }
    .full { width: 100%; }

    .card {
      margin-top: 10px;
      background: linear-gradient(160deg, var(--card), var(--card-2));
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
    }
    .muted { color: var(--muted); }
    .title { margin: 0; font-size: 17px; }
    .small { font-size: 12px; }
    .input {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(0,0,0,0.2);
      color: var(--text);
      padding: 12px;
      outline: none;
    }
    .status {
      display: inline-flex;
      align-items: center;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid var(--line);
      padding: 5px 9px;
    }
    .st-open { color: var(--warn); }
    .st-playing { color: #82b9ff; }
    .st-dispute { color: #ffc978; }
    .st-completed { color: #7fffbc; }
    .win-highlight { color: #38d17f; font-size: 18px; font-weight: 800; display: block; margin-top: 5px; }
    .room-code {
      margin-top: 8px;
      font-size: 30px;
      letter-spacing: 1px;
      font-weight: 800;
      color: #ffd76c;
      text-align: center;
      border: 1px dashed rgba(255, 215, 108, 0.6);
      border-radius: 12px;
      padding: 8px;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.75);
      display: none;
      z-index: 50;
    }
    .overlay.show { display: block; }
    .modal {
      position: fixed;
      z-index: 60;
      width: min(92%, 460px);
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #08162c;
      padding: 20px;
      display: none;
    }
    .modal.show { display: block; }
  </style>
</head>
<body>
  <div class="app">
    <header class="sticky-header">
      <a class="back-btn" href="index.html">← Home</a>
      <div class="wallets">
        <div class="pill cash">Cash<strong id="cashAmount">₹0</strong></div>
        <div class="pill winning">Winning<strong id="winAmount">₹0</strong></div>
      </div>
    </header>

    <main class="content">
      <section class="section row space-between">
        <div class="online"><span class="dot"></span> Online Players: <strong id="onlinePlayers">500+</strong></div>
        <button id="rulesBtn" class="btn-muted" type="button">Rules</button>
      </section>

      <section class="section card">
        <h3 class="title">Create Battle</h3>
        <p class="muted small">Enter amount (multiples of 50 only). Smart deduction: win_balance first, then cash wallet.</p>
        <div class="row" style="margin-top:10px;">
          <input id="battleAmount" class="input" type="number" min="50" step="50" placeholder="e.g. 100" />
          <button id="createBattleBtn" class="btn" type="button">Create</button>
        </div>
      </section>

      <section class="section">
        <h3 class="title">Open Battles</h3>
        <div id="openBattles"></div>
      </section>

      <section class="section">
        <h3 class="title">My Running Battles</h3>
        <div id="runningBattles"></div>
      </section>
    </main>
  </div>

  <div id="overlay" class="overlay"></div>

  <section id="rulesModal" class="modal" role="dialog" aria-modal="true">
    <h3 class="title">Battle Rules</h3>
    <ul class="muted small">
      <li>Agar popular code aye toh aap screen recording karke game left kare</li>
      <li>Agar samne wale theme Se khel raha he apko nahi khelna toh opponent ki 2 goti khulne se phele game screen recording karke game left kare</li>
      <li>50 rupay cut hoga galat screenshot dalne pe</li>
      <li>2% referral commission is credited to referrer cash wallet on successful completion.</li>
      <li>Humare platform par withdrawls 15 minutes me diya jata hai</li>
      <li>exit ya auto exit: Agar 1 bhi goti 10 kadam chali h -> 100% win</li>
      <li>Site pe cancel karne se phele ludoking me game exit karein</li>
    </ul>
    <button class="btn full" data-close-modal="rulesModal" type="button">Close</button>
  </section>

  <section id="winModal" class="modal" role="dialog" aria-modal="true">
    <h3 class="title">Upload Winning Screenshot</h3>
    <p class="small muted">Screenshot required for "I WIN" claim. Match will move to dispute for admin verification.</p>
    <input id="winFile" class="input" type="file" accept="image/*" />
    <div class="row" style="margin-top:10px;">
      <button id="submitWinBtn" class="btn btn-gold full" type="button">Upload & Submit</button>
      <button class="btn-muted" data-close-modal="winModal" type="button">Cancel</button>
    </div>
  </section>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, ref, onValue, push, get, set, update, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyAx0fr47IsOtBxakcBj1ndwDYle_XlaE-Y',
      authDomain: 'sr-ludo-4440b.firebaseapp.com',
      databaseURL: 'https://sr-ludo-4440b-default-rtdb.firebaseio.com',
      projectId: 'sr-ludo-4440b',
      storageBucket: 'sr-ludo-4440b.firebasestorage.app',
      messagingSenderId: '1080387235822',
      appId: '1:1080387235822:web:77faea231641837950e8ff'
    };

    const IMGBB_API_KEY = window.IMGBB_API_KEY || localStorage.getItem('sr_ludo_imgbb_api_key') || 'ca44783bda6779b5e3913432bd243b30';

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const phoneFromEmail = user.email.split('@')[0];
        const finalPhone = (phoneFromEmail.length === 10) ? "+91" + phoneFromEmail : phoneFromEmail;
        localStorage.setItem('sr_ludo_phone', finalPhone);
        startApp(); 
      } else {
        window.location.href = 'index.html';
      }
    });

    const cashAmount = document.getElementById('cashAmount');
    const winAmount = document.getElementById('winAmount');
    const battleAmount = document.getElementById('battleAmount');
    const createBattleBtn = document.getElementById('createBattleBtn');
    const openBattles = document.getElementById('openBattles');
    const runningBattles = document.getElementById('runningBattles');
    const rulesBtn = document.getElementById('rulesBtn');
    const rulesModal = document.getElementById('rulesModal');
    const winModal = document.getElementById('winModal');
    const overlay = document.getElementById('overlay');
    const submitWinBtn = document.getElementById('submitWinBtn');
    const winFile = document.getElementById('winFile');

    let myUser = { balance: 0, win_balance: 0 };
    let pendingWinBattleId = null;
    let battlesCache = {};
    let phone = localStorage.getItem('sr_ludo_phone');

    const fmt = (n = 0) => `₹${Number(n || 0).toLocaleString('en-IN')}`;
    const maskPhone = (ph) => ph ? `SR Player-${ph.toString().slice(-4)}` : 'SR Player';
    const statusClass = (st = '') => ({ open: 'st-open', playing: 'st-playing', pending: 'st-dispute', dispute: 'st-dispute', completed: 'st-completed' }[st] || '');
    
    const computeWinAmount = (amount) => {
      const a = Number(amount || 0);
      if (a <= 0) return 0;
      if (a >= 500) {
        const pool = a * 2;
        return Math.round(pool - (pool * 0.03));
      }
      return Math.round(a * 1.9);
    };

    const showModal = (node) => { node.classList.add('show'); overlay.classList.add('show'); };
    const closeModal = (node) => { node.classList.remove('show'); if (!document.querySelector('.modal.show')) overlay.classList.remove('show'); };
    const validateAmount = (amount) => Number.isFinite(amount) && amount > 0 && amount % 50 === 0;

    async function deductSmartWallet(userPhone, amount) {
      const userRef = ref(db, `users/${userPhone}`);
      const required = Number(amount || 0);
      let deduction = null;
      const result = await runTransaction(userRef, (user) => {
        if (!user) return user;
        const winBal = Number(user.win_balance || 0);
        const cashBal = Number(user.balance || 0);
        if (winBal + cashBal < required) return;
        const fromWin = Math.min(winBal, required);
        const fromCash = required - fromWin;
        user.win_balance = winBal - fromWin;
        user.balance = cashBal - fromCash;
        deduction = { fromWin, fromCash };
        return user;
      });
      if (!result.committed || !deduction) throw new Error('Insufficient wallet balance.');
      return deduction;
    }

    async function creditWinning(userPhone, amount) {
      await runTransaction(ref(db, `users/${userPhone}`), (user) => {
        if (!user) return user;
        user.win_balance = Number(user.win_balance || 0) + Number(amount || 0);
        return user;
      });
    }

    async function processReferralCommission(winnerPhone, winAmount) {
      try {
        const userSnap = await get(ref(db, `users/${winnerPhone}`));
        const referrerPhone = userSnap.val()?.referredBy;
        if (referrerPhone) {
          const commission = Math.round(winAmount * 0.01053);
          if (commission > 0) {
            await runTransaction(ref(db, `users/${referrerPhone}`), (user) => {
              if (user) {
                user.referral_balance = (user.referral_balance || 0) + commission;
                user.referral_earnings_total = (user.referral_earnings_total || 0) + commission;
              }
              return user;
            });
          }
        }
      } catch (e) { console.error(e); }
    }

    async function ensureUserRecord() {
      const userRef = ref(db, `users/${phone}`);
      const userSnap = await get(userRef);
      if (!userSnap.exists()) {
        await set(userRef, { phone, balance: 0, win_balance: 0, time: Date.now() });
      }
    }

    async function createBattle() {
      const amount = Number(battleAmount.value);
      if (!validateAmount(amount)) return alert('Amount should be multiple of 50.');
      createBattleBtn.disabled = true;
      try {
        const deduction = await deductSmartWallet(phone, amount);
        const battleRef = push(ref(db, 'battles'));
        await set(battleRef, {
          id: battleRef.key, amount, winAmount: computeWinAmount(amount),
          status: 'open', creatorPhone: phone, creatorDeduct: deduction,
          createdAt: Date.now(), updatedAt: Date.now()
        });
        battleAmount.value = '';
      } catch (e) { alert(e.message); } finally { createBattleBtn.disabled = false; }
    }

    async function joinBattle(battleId) {
      const battleRef = ref(db, `battles/${battleId}`);
      const claimTx = await runTransaction(battleRef, (battle) => {
        if (!battle || battle.status !== 'open' || battle.creatorPhone === phone) return;
        battle.status = 'joining';
        battle.joinerPhone = phone;
        return battle;
      });
      if (!claimTx.committed) return alert('Cannot join battle.');
      try {
        const deduction = await deductSmartWallet(phone, claimTx.snapshot.val().amount);
        await update(battleRef, { status: 'playing', joinerDeduct: deduction, startedAt: Date.now(), updatedAt: Date.now() });
      } catch (e) {
        await update(battleRef, { status: 'open', joinerPhone: null });
        alert(e.message);
      }
    }

    async function setRoomCode(battleId, code) {
      if (!code) return alert('Enter room code.');
      await update(ref(db, `battles/${battleId}`), { roomCode: code, room_code: code, roomCodeAt: Date.now() });
    }

    async function declareLost(battleId) {
      const battleRef = ref(db, `battles/${battleId}`);
      const tx = await runTransaction(battleRef, (battle) => {
        if (!battle || battle.settledAt) return;
        const isCreator = battle.creatorPhone === phone;
        battle.status = 'completed';
        battle.winnerPhone = isCreator ? battle.joinerPhone : battle.creatorPhone;
        battle.loserPhone = phone;
        battle.settledAt = Date.now();
        return battle;
      });
      if (tx.committed) {
        const b = tx.snapshot.val();
        await creditWinning(b.winnerPhone, b.winAmount);
        await processReferralCommission(b.winnerPhone, b.winAmount);
      }
    }

    async function uploadToImgBB(file) {
      const fd = new FormData(); fd.append('image', file);
      const resp = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
      const json = await resp.json();
      return json.data.url;
    }

    async function declareWinWithScreenshot() {
      if (!pendingWinBattleId || !winFile.files[0]) return alert('Upload screenshot.');
      submitWinBtn.disabled = true;
      try {
        const url = await uploadToImgBB(winFile.files[0]);
        await update(ref(db, `battles/${pendingWinBattleId}`), {
          status: 'pending', screenshot_url: url, winnerPhone: phone, updatedAt: Date.now()
        });
        closeModal(winModal);
      } catch (e) { alert(e.message); } finally { submitWinBtn.disabled = false; }
    }

    function renderOpenBattles(data) {
      const list = Object.values(data || {}).filter(b => b.status === 'open');
      openBattles.innerHTML = list.length ? list.map(b => `
        <div class="card">
          <div class="row space-between"><strong>₹${b.amount}</strong><span class="status st-open">OPEN</span></div>
          <div class="win-highlight">Win: ${fmt(b.winAmount)}</div>
          <div class="row" style="margin-top:10px;">
            ${b.creatorPhone === phone ? `<button class="btn-danger btn full" onclick="alert('Cancelled')">Cancel</button>` : `<button class="btn btn-gold full" data-action="join" data-id="${b.id}">JOIN NOW</button>`}
          </div>
        </div>`).join('') : '<div class="card muted small">No open battles.</div>';
    }

    function renderRunningBattles(data) {
      const list = Object.values(data || {}).filter(b => [b.creatorPhone, b.joinerPhone].includes(phone) && ['playing', 'pending'].includes(b.status));
      runningBattles.innerHTML = list.map(b => `
        <div class="card">
          <div class="row space-between"><strong>Battle ₹${b.amount}</strong><span class="status ${statusClass(b.status)}">${b.status}</span></div>
          <div class="win-highlight">Win: ${fmt(b.winAmount)}</div>
          ${b.status === 'playing' ? `
            <div class="room-code">${b.roomCode || 'WAITING...'}</div>
            ${b.creatorPhone === phone && !b.roomCode ? `<input id="rc-${b.id}" class="input" placeholder="Room Code"/><button class="btn full" data-action="set-room" data-id="${b.id}">Set Room</button>` : ''}
            <div class="row" style="margin-top:10px;">
              <button class="btn btn-win full" data-action="i-win" data-id="${b.id}">I WIN</button>
              <button class="btn btn-danger full" data-action="i-lost" data-id="${b.id}">I LOST</button>
            </div>` : '<p class="small muted">Result pending admin...</p>'}
        </div>`).join('') || '<div class="card muted small">No running battles.</div>';
    }

    document.body.addEventListener('click', e => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const { action, id } = btn.dataset;
      if (action === 'join') joinBattle(id);
      if (action === 'i-lost') declareLost(id);
      if (action === 'i-win') { pendingWinBattleId = id; showModal(winModal); }
      if (action === 'set-room') setRoomCode(id, document.getElementById(`rc-${id}`).value);
    });

    function startApp() {
      ensureUserRecord();
      onValue(ref(db, `users/${phone}`), s => {
        const u = s.val() || {};
        myUser = u;
        cashAmount.textContent = fmt(u.balance);
        winAmount.textContent = fmt(u.win_balance);
      });
      onValue(ref(db, 'battles'), s => {
        const data = s.val() || {};
        renderOpenBattles(data);
        renderRunningBattles(data);
      });
      onValue(ref(db, 'app_stats/online_players'), s => {
        document.getElementById('onlinePlayers').textContent = (s.val() || 500) + '+';
      });
    }

    rulesBtn.onclick = () => showModal(rulesModal);
    overlay.onclick = () => { closeModal(rulesModal); closeModal(winModal); };
    document.querySelectorAll('[data-close-modal]').forEach(b => b.onclick = () => closeModal(document.getElementById(b.dataset.closeModal)));
    submitWinBtn.onclick = declareWinWithScreenshot;
  </script>
</body>
</html>
