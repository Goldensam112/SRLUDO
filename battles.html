<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SR LUDO | Battles</title>
  
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #040913; --card: #0d1b33; --card-2: #102340; --text: #e8efff; --muted: #9fb0d1;
      --line: rgba(255, 255, 255, 0.08); --accent: #2f7bff; --accent-2: #18b3ff;
      --gold-1: #a86b00; --gold-2: #ffd05a; --danger: #ff3d4d; --ok: #38d17f; --warn: #ffb34a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: 'Inter', system-ui, sans-serif;
      background: radial-gradient(1200px 500px at 50% -200px, #154b99 0%, var(--bg) 65%);
      color: var(--text);
    }
    .app { max-width: 540px; margin: 0 auto; min-height: 100vh; border-left: 1px solid rgba(255,255,255,.05); border-right: 1px solid rgba(255,255,255,.05); background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); padding-bottom: 86px; }
    .sticky-header { position: sticky; top: 0; z-index: 30; backdrop-filter: blur(10px); background: rgba(4, 9, 19, 0.88); border-bottom: 1px solid var(--line); padding: 12px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .back-btn { border: 1px solid var(--line); background: rgba(255,255,255,.04); color: var(--text); border-radius: 10px; padding: 8px 10px; text-decoration: none; font-size: 13px; white-space: nowrap; }
    .wallets { display: flex; gap: 8px; }
    .pill { min-width: 108px; border-radius: 999px; padding: 7px 11px; font-size: 12px; border: 1px solid rgba(255,255,255,.24); }
    .pill strong { display: block; margin-top: 1px; font-size: 14px; }
    .cash { background: linear-gradient(130deg, #0f49b3, #2a89ff); }
    .winning { background: linear-gradient(130deg, var(--gold-1), var(--gold-2)); color: #1f1711; }
    .content { padding: 14px; }
    .section { margin-top: 14px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .space-between { justify-content: space-between; }
    .online { display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--line); background: rgba(255,255,255,.03); border-radius: 999px; padding: 8px 12px; color: var(--muted); font-size: 12px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--danger); box-shadow: 0 0 10px var(--danger); animation: blink 1.05s infinite; }
    @keyframes blink { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: .35; transform: scale(.8); } }
    .btn { border: 0; border-radius: 12px; padding: 11px 12px; color: #fff; font-weight: 700; cursor: pointer; background: linear-gradient(100deg, var(--accent), var(--accent-2)); }
    .btn-muted { border: 1px solid var(--line); border-radius: 12px; padding: 10px 12px; color: var(--text); background: rgba(255,255,255,.05); cursor: pointer; }
    .btn-gold { background: linear-gradient(130deg, #9b6400, #ffcf57); color: #1f1711; }
    .btn-danger { background: linear-gradient(120deg, #c71c30, #ff3d4d); }
    .btn-win { background: linear-gradient(120deg, #0f8f45, #25cc71); }
    .full { width: 100%; }
    .card { margin-top: 10px; background: linear-gradient(160deg, var(--card), var(--card-2)); border: 1px solid var(--line); border-radius: 16px; padding: 12px; }
    .muted { color: var(--muted); }
    .title { margin: 0; font-size: 17px; }
    .small { font-size: 12px; }
    .input { width: 100%; border: 1px solid var(--line); border-radius: 12px; background: rgba(255,255,255,.03); color: var(--text); padding: 12px; outline: none; }
    .status { display: inline-flex; align-items: center; font-size: 11px; border-radius: 999px; border: 1px solid var(--line); padding: 5px 9px; }
    .st-open { color: var(--warn); }
    .st-playing { color: #82b9ff; }
    .st-dispute { color: #ffc978; }
    .st-completed { color: #7fffbc; }
    .room-code { margin-top: 8px; font-size: 30px; letter-spacing: 1px; font-weight: 800; color: #ffd76c; text-align: center; border: 1px dashed rgba(255, 215, 108, 0.6); border-radius: 12px; padding: 8px; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; z-index: 50; }
    .overlay.show { display: block; }
    .modal { position: fixed; z-index: 60; width: min(92%, 460px); left: 50%; top: 50%; transform: translate(-50%, -50%); border: 1px solid var(--line); border-radius: 16px; background: #08162c; padding: 14px; display: none; }
    .modal.show { display: block; }

    /* ✅ GREEN WINNING UI */
    .win-display {
      color: var(--ok); font-size: 15px; font-weight: 800;
      background: rgba(56, 209, 127, 0.1); padding: 4px 10px;
      border-radius: 8px; border: 1px solid rgba(56, 209, 127, 0.2);
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="sticky-header">
      <a class="back-btn" href="index.html">← Home</a>
      <div class="wallets">
        <div class="pill cash">Cash<strong id="cashAmount">₹0</strong></div>
        <div class="pill winning">Winning<strong id="winAmount">₹0</strong></div>
      </div>
    </header>

    <main class="content">
      <section class="section row space-between">
        <div class="online"><span class="dot"></span> Online Players: <strong id="onlinePlayers">500+</strong></div>
        <button id="rulesBtn" class="btn-muted" type="button">Rules</button>
      </section>

      <section class="section card">
        <h3 class="title">Create Battle</h3>
        <p class="muted small">Enter amount (multiples of 50 only). Smart deduction applied.</p>
        <div class="row">
          <input id="battleAmount" class="input" type="number" min="50" step="50" placeholder="e.g. 100" />
          <button id="createBattleBtn" class="btn" type="button">Create</button>
        </div>
      </section>

      <section class="section">
        <h3 class="title">Open Battles</h3>
        <div id="openBattles"></div>
      </section>

      <section class="section">
        <h3 class="title">My Running Battles</h3>
        <div id="runningBattles"></div>
      </section>
    </main>
  </div>

  <div id="overlay" class="overlay"></div>

  <section id="rulesModal" class="modal">
    <h3 class="title">Battle Rules</h3>
    <ul class="muted small">
      <li>Winner/Loser declarations are final unless dispute opened.</li>
    </ul>
    <button class="btn full" data-close-modal="rulesModal" type="button">Close</button>
  </section>

  <section id="winModal" class="modal">
    <h3 class="title">Upload Screenshot</h3>
    <input id="winFile" class="input" type="file" accept="image/*" />
    <button id="submitWinBtn" class="btn btn-gold full" style="margin-top:10px;">Upload & Submit</button>
  </section>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, ref, onValue, push, get, set, update, runTransaction, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyAx0fr47IsOtBxakcBj1ndwDYle_XlaE-Y',
      authDomain: 'sr-ludo-4440b.firebaseapp.com',
      databaseURL: 'https://sr-ludo-4440b-default-rtdb.firebaseio.com',
      projectId: 'sr-ludo-4440b',
      storageBucket: 'sr-ludo-4440b.firebasestorage.app',
      messagingSenderId: '1080387235822',
      appId: '1:1080387235822:web:77faea231641837950e8ff'
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const phone = localStorage.getItem('sr_ludo_phone');
    if (!phone) window.location.href = 'index.html';

    // ... [REST OF YOUR 700+ LINES LOGIC REMAINS EXACTLY SAME] ...
    // [I am providing the modified rendering functions below]

    function renderOpenBattles(data) {
      const list = Object.values(data || {}).filter((b) => b?.status === 'open').sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      if (!list.length) {
        openBattles.innerHTML = '<div class="card muted small">No open battles.</div>';
        return;
      }
      openBattles.innerHTML = list.map((b) => {
        const mine = b.creatorPhone === phone;
        return `
          <div class="card">
            <div class="row space-between">
              <strong>Battle ₹${b.amount}</strong>
              <span class="status ${statusClass(b.status)}">${b.status.toUpperCase()}</span>
            </div>
            <div class="row space-between" style="margin-top:10px; align-items:center;">
              <div class="small muted">ID: ${b.id.slice(-6)} • Creator: SR Player</div>
              <div class="win-display">Win: ₹${b.winAmount}</div>
            </div>
            <div class="row" style="margin-top:10px;">
              ${mine ? `<button class="btn-danger btn full" data-action="cancel" data-id="${b.id}">Cancel</button>` : `<button class="btn btn-gold full" data-action="join" data-id="${b.id}">Join Battle</button>`}
            </div>
          </div>`;
      }).join('');
    }

    function renderRunningBattles(data) {
      const list = Object.values(data || {}).filter((b) => [b.creatorPhone, b.joinerPhone].includes(phone) && ['playing', 'pending', 'dispute'].includes(b.status));
      if (!list.length) {
        runningBattles.innerHTML = '<div class="card muted small">No running battles.</div>';
        return;
      }
      runningBattles.innerHTML = list.map((b) => `
        <div class="card">
          <div class="row space-between">
            <strong>Battle ₹${b.amount}</strong>
            <span class="status ${statusClass(b.status)}">${b.status.toUpperCase()}</span>
          </div>
          <div class="row space-between" style="margin-top:8px; align-items:center;">
            <div class="small muted">Creator: SR Player • Joiner: ${b.joinerPhone ? 'SR Player' : '-'}</div>
            <div class="win-display">Winning: ₹${b.winAmount}</div>
          </div>
          ${battleControls(b)}
        </div>`).join('');
    }

    // [KEEP ALL YOUR 700+ LINES OF FUNCTIONS LIKE joinBattle, createBattle, deductSmartWallet, etc. HERE]
    // syncWalletRealtime(); syncBattlesRealtime(); etc.
  </script>
</body>
</html>
