<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SR LUDO | Profile & KYC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #040913;
      --card: #0d1b33;
      --card-2: #102340;
      --text: #e8efff;
      --muted: #9fb0d1;
      --line: rgba(255,255,255,.08);
      --accent: #2f7bff;
      --accent-2: #18b3ff;
      --success: #2ecf72;
      --warning: #f9c74f;
      --danger: #ff5b6e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(1200px 500px at 50% -200px, #154b99 0%, var(--bg) 65%);
      color: var(--text);
    }
    .app {
      max-width: 540px;
      margin: 0 auto;
      min-height: 100vh;
      border-left: 1px solid rgba(255,255,255,.05);
      border-right: 1px solid rgba(255,255,255,.05);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      padding-bottom: 26px;
    }
    .header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(8px);
      background: rgba(4,9,19,.88);
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
    }
    .icon-btn {
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 10px;
      width: 38px;
      height: 38px;
      display: grid;
      place-items: center;
      text-decoration: none;
      cursor: pointer;
    }
    .title { font-weight: 800; letter-spacing: .8px; }
    .content { padding: 14px; display: grid; gap: 12px; }

    .card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(160deg, var(--card), var(--card-2));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      padding: 14px;
    }
    .status-wrap { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .badge {
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid transparent;
      text-transform: uppercase;
      letter-spacing: .4px;
    }
    .pending { color: #2a2002; background: rgba(249, 199, 79, .92); border-color: rgba(249,199,79,.7); }
    .verified { color: #03220f; background: rgba(46, 207, 114, .92); border-color: rgba(46, 207, 114, .7); }
    .rejected { color: #35040a; background: rgba(255, 91, 110, .92); border-color: rgba(255,91,110,.7); }

    .label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 7px; }
    .input {
      width: 100%;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding: 11px;
      outline: none;
      margin-bottom: 10px;
      font-family: inherit;
    }
    .input:focus { border-color: rgba(24,179,255,.8); box-shadow: 0 0 0 3px rgba(24,179,255,.2); }
    .input:disabled { opacity: .65; cursor: not-allowed; }

    .btn {
      border: 0;
      border-radius: 12px;
      padding: 12px;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
    }
    .btn-primary { background: linear-gradient(100deg, var(--accent), var(--accent-2)); }
    .btn-wa { background: linear-gradient(110deg, #0e9245, #31cb75); text-decoration: none; display: inline-block; text-align: center; }
    .btn-lite { background: rgba(255,255,255,.06); border: 1px solid var(--line); }

    .row { display: flex; gap: 8px; }
    .grow { flex: 1; }
    .help { margin: 0; color: var(--muted); font-size: 12px; }
    .lock-msg {
      border: 1px solid rgba(249,199,79,.45);
      background: rgba(249,199,79,.08);
      color: #f7da91;
      padding: 10px;
      border-radius: 10px;
      font-size: 12px;
      margin-bottom: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <a class="icon-btn" href="index.html">‚Üê</a>
      <div class="title">MY PROFILE</div>
      <a class="icon-btn" href="wallet.html">üíº</a>
    </header>

    <main class="content">
      <section class="card">
        <div class="status-wrap">
          <div>
            <h3 style="margin:0 0 6px;">KYC Status</h3>
            <p class="help" style="margin:0;">Your verification state from Firebase.</p>
          </div>
          <span id="kycBadge" class="badge pending">Pending</span>
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px;">KYC Verification</h3>
        <label class="label" for="fullNameInput">Full Name (As per Aadhar)</label>
        <input id="fullNameInput" class="input" type="text" placeholder="Enter full name" />

        <label class="label" for="aadharNumberInput">Aadhar Card Number</label>
        <input id="aadharNumberInput" class="input" type="text" inputmode="numeric" maxlength="12" placeholder="12-digit Aadhar number" />

        <label class="label" for="aadharFileInput">Aadhar Front Photo</label>
        <input id="aadharFileInput" class="input" type="file" accept="image/*" />

        <button id="submitKycBtn" class="btn btn-primary" type="button" style="width:100%;">Submit KYC</button>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px;">Payment & Bank Details</h3>
        <div id="lockMessage" class="lock-msg">Bank details are locked for security. To change, contact Admin on WhatsApp.</div>

        <label class="label" for="upiInput">UPI ID</label>
        <input id="upiInput" class="input" type="text" placeholder="name@upi" />

        <label class="label" for="bankAccInput">Bank Account Number</label>
        <input id="bankAccInput" class="input" type="text" inputmode="numeric" placeholder="Enter account number" />

        <label class="label" for="ifscInput">Bank IFSC Code</label>
        <input id="ifscInput" class="input" type="text" placeholder="Enter IFSC" />

        <button id="saveBankBtn" class="btn btn-primary" type="button" style="width:100%;">Save Bank Details</button>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px;">Referral & Support</h3>
        <label class="label">Your Referral Code</label>
        <div class="row" style="margin-bottom:10px;">
          <input id="referralCodeInput" class="input grow" type="text" readonly />
          <button id="copyReferralBtn" class="btn btn-lite" type="button">Copy</button>
        </div>

        <a class="btn btn-wa" href="https://wa.me/916261642944" target="_blank" rel="noopener" style="width:100%;">WhatsApp Support</a>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, onValue, ref, update } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyAx0fr47IsOtBxakcBj1ndwDYle_XlaE-Y',
      authDomain: 'sr-ludo-4440b.firebaseapp.com',
      databaseURL: 'https://sr-ludo-4440b-default-rtdb.firebaseio.com',
      projectId: 'sr-ludo-4440b',
      storageBucket: 'sr-ludo-4440b.firebasestorage.app',
      messagingSenderId: '1080387235822',
      appId: '1:1080387235822:web:77faea231641837950e8ff'
    };

    const IMGBB_API_KEY = 'YOUR_IMGBB_API_KEY';
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const phone = (localStorage.getItem('sr_ludo_phone') || '').trim();
    if (!phone) {
      window.location.href = 'index.html';
      throw new Error('No phone found in localStorage.');
    }

    const userRef = ref(db, `users/${phone}`);

    const kycBadge = document.getElementById('kycBadge');
    const fullNameInput = document.getElementById('fullNameInput');
    const aadharNumberInput = document.getElementById('aadharNumberInput');
    const aadharFileInput = document.getElementById('aadharFileInput');
    const submitKycBtn = document.getElementById('submitKycBtn');
    const upiInput = document.getElementById('upiInput');
    const bankAccInput = document.getElementById('bankAccInput');
    const ifscInput = document.getElementById('ifscInput');
    const saveBankBtn = document.getElementById('saveBankBtn');
    const lockMessage = document.getElementById('lockMessage');
    const referralCodeInput = document.getElementById('referralCodeInput');
    const copyReferralBtn = document.getElementById('copyReferralBtn');

    function statusClass(status) {
      if (status === 'verified') return 'verified';
      if (status === 'rejected') return 'rejected';
      return 'pending';
    }

    async function uploadToImgBB(file) {
      if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY') {
        throw new Error('ImgBB API key missing in profile.html');
      }
      const fd = new FormData();
      fd.append('image', file);
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
        method: 'POST',
        body: fd
      });
      const data = await response.json();
      if (!response.ok || !data?.success || !data?.data?.url) {
        throw new Error(data?.error?.message || 'Image upload failed.');
      }
      return data.data.url;
    }

    function setBankLockState(isLocked) {
      upiInput.disabled = isLocked;
      bankAccInput.disabled = isLocked;
      ifscInput.disabled = isLocked;
      lockMessage.style.display = isLocked ? 'block' : 'none';
      saveBankBtn.style.display = isLocked ? 'none' : 'block';
    }

    onValue(userRef, (snapshot) => {
      const user = snapshot.val() || {};
      const kycStatus = (user.kyc_status || 'pending').toLowerCase();

      kycBadge.className = `badge ${statusClass(kycStatus)}`;
      kycBadge.textContent = kycStatus === 'verified' ? 'Verified ‚úÖ' : kycStatus.charAt(0).toUpperCase() + kycStatus.slice(1);

      fullNameInput.value = user.full_name || '';
      aadharNumberInput.value = user.aadhar_no || '';
      upiInput.value = user.upi_id || '';
      bankAccInput.value = user.bank_acc || '';
      ifscInput.value = user.bank_ifsc || '';

      const referralDigits = phone.replace(/\D/g, '').slice(-6) || '000000';
      referralCodeInput.value = `SR${referralDigits}`;

      const lockBank = Boolean((user.upi_id || '').trim() || (user.bank_acc || '').trim() || (user.bank_ifsc || '').trim());
      setBankLockState(lockBank);
    });

    submitKycBtn.addEventListener('click', async () => {
      const fullName = fullNameInput.value.trim();
      const aadharNo = aadharNumberInput.value.trim();
      const file = aadharFileInput.files?.[0];

      if (!fullName || !aadharNo || !file) {
        alert('Please fill all KYC fields and upload Aadhar front photo.');
        return;
      }

      if (!/^\d{12}$/.test(aadharNo)) {
        alert('Please enter a valid 12-digit Aadhar number.');
        return;
      }

      submitKycBtn.disabled = true;
      submitKycBtn.textContent = 'Uploading...';
      try {
        const aadharUrl = await uploadToImgBB(file);
        await update(userRef, {
          full_name: fullName,
          aadhar_no: aadharNo,
          aadhar_url: aadharUrl,
          aadhar_f: aadharUrl,
          kyc_status: 'pending',
          kyc_updated_at: Date.now()
        });
        alert('KYC submitted successfully. Status updated to pending.');
        aadharFileInput.value = '';
      } catch (error) {
        console.error(error);
        alert(error.message || 'KYC submit failed.');
      } finally {
        submitKycBtn.disabled = false;
        submitKycBtn.textContent = 'Submit KYC';
      }
    });

    saveBankBtn.addEventListener('click', async () => {
      const upiId = upiInput.value.trim();
      const bankAcc = bankAccInput.value.trim();
      const bankIfsc = ifscInput.value.trim().toUpperCase();
      if (!upiId || !bankAcc || !bankIfsc) {
        alert('Please fill all bank/payment fields.');
        return;
      }

      saveBankBtn.disabled = true;
      saveBankBtn.textContent = 'Saving...';
      try {
        await update(userRef, {
          upi_id: upiId,
          bank_acc: bankAcc,
          bank_ifsc: bankIfsc,
          bank_saved_at: Date.now()
        });
        alert('Bank details saved and locked.');
      } catch (error) {
        console.error(error);
        alert('Unable to save bank details. Please try again.');
      } finally {
        saveBankBtn.disabled = false;
        saveBankBtn.textContent = 'Save Bank Details';
      }
    });

    copyReferralBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(referralCodeInput.value.trim());
        copyReferralBtn.textContent = 'Copied';
        setTimeout(() => { copyReferralBtn.textContent = 'Copy'; }, 1200);
      } catch {
        alert('Copy failed. Please copy manually.');
      }
    });
  </script>
</body>
</html>
