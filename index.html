<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SR LUDO | Premium Battle Arena</title>
  
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://www.phone.email/sign_in_button_v1.js" async></script>
  <style>
    :root {
      --bg: #040913; --card: #ffffff; --card-dark: #0d1b33; --text: #e8efff;
      --text-dark: #1e293b; --muted: #9fb0d1; --line: rgba(255, 255, 255, 0.08);
      --accent: #2f7bff; --gold-1: #a86b00; --gold-2: #ffd05a; --danger: #ff3d4d;
      --shadow: 0 16px 40px rgba(0, 0, 0, 0.45); --ok: #38d17f; --warn: #ffb34a;
    }
    body { margin: 0; font-family: 'Inter', sans-serif; background: radial-gradient(1200px 500px at 50% -200px, #154b99 0%, var(--bg) 65%); color: var(--text); min-height: 100vh; visibility: hidden; opacity: 0; }
    body.ready { visibility: visible; opacity: 1; transition: opacity 0.2s ease-in; }
    * { box-sizing: border-box; }
    .hidden { display: none !important; }
    .app { max-width: 540px; margin: 0 auto; min-height: 100vh; position: relative; background: #f1f5f9; padding-bottom: 90px; }
    .sidebar { position: fixed; inset: 0 auto 0 0; width: 78%; max-width: 320px; background: #09172d; border-right: 1px solid var(--line); z-index: 150; transform: translateX(-100%); transition: transform 0.24s ease; padding: 16px; }
    .sidebar.open { transform: translateX(0); }
    .menu-link { display: block; color: var(--text); text-decoration: none; border: 1px solid var(--line); padding: 11px 12px; border-radius: 10px; margin-bottom: 10px; background: rgba(255,255,255,0.02); font-size: 14px; }
    .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.65); z-index: 140; display: none; }
    .overlay.show { display: block; }
    .login-screen { min-height: 100vh; display: grid; place-items: center; padding: 20px; background: #0f172a; }
    .login-card { width: 100%; background: white; border-radius: 24px; padding: 28px 20px; text-align: center; }
    .main-logo { height: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px var(--accent)); }
    .sticky-header { position: sticky; top: 0; z-index: 100; background: #1e293b; padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; }
    .hamburger { border: none; background: none; color: white; font-size: 24px; cursor: pointer; }
    .nav-logo { height: 35px; }
    .wallets { display: flex; gap: 8px; }
    .pill { min-width: 90px; border-radius: 999px; padding: 7px 11px; font-size: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.2); color: white; }
    .pill strong { display: block; font-size: 13px; margin-top: 2px; }
    .cash-pill { background: linear-gradient(130deg, #0f49b3, #2a89ff); }
    .win-pill { background: linear-gradient(130deg, var(--gold-1), var(--gold-2)); color: #1f1711; }
    .announcement { background: linear-gradient(90deg, #0f172a, #1e293b); margin: 15px; padding: 15px; border-radius: 12px; border: 1.5px solid var(--gold-2); color: white; text-align: center; font-size: 13px; font-weight: 500; }
    .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px; }
    .game-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: var(--shadow); position: relative; cursor: pointer; aspect-ratio: 1/1.2; display: flex; flex-direction: column; align-items: center; border: 1px solid #e2e8f0; }
    .game-card .img-wrap { width: 100%; height: 75%; overflow: hidden; }
    .game-card img { width: 100%; height: 100%; object-fit: cover; }
    .game-label { height: 25%; width: 100%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--text-dark); }
    .modal { position: fixed; left: 50%; top: 50%; width: min(92%, 460px); transform: translate(-50%, -50%); background: #0a1a32; border: 1px solid var(--line); border-radius: 14px; z-index: 200; padding: 16px; display: none; max-height: 75vh; overflow-y: auto; color: white; }
    .modal.show { display: block; }
    .record { border: 1px solid var(--line); border-radius: 10px; padding: 10px; margin-bottom: 8px; font-size: 12px; background: rgba(255,255,255,0.05); }
    .bottom-nav { position: fixed; left: 50%; transform: translateX(-50%); bottom: 0; width: min(540px, 100%); background: #ffffff; border-top: 1px solid #e2e8f0; display: grid; grid-template-columns: repeat(5, 1fr); padding: 10px 0; z-index: 100; }
    .nav-item { color: #64748b; text-align: center; font-size: 10px; text-decoration: none; }
    .nav-item.active { color: var(--accent); }
    .dot { width: 6px; height: 6px; background: var(--danger); border-radius: 50%; animation: blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
  </style>
</head>
<body>

  <div class="app">
    <section id="loginScreen" class="login-screen hidden">
      <div class="login-card">
        <img src="logo.png" alt="Logo" class="main-logo">
        <p style="color:var(--text-dark); margin-bottom: 20px;">Premium Battle Arena</p>
        <input id="referralCode" type="text" placeholder="Referral Code (Optional)" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;">
        <button id="loginBtn" style="width:100%; padding:14px; background:var(--accent); border:none; border-radius:12px; color:white; font-weight:700; cursor:pointer;">Continue</button>
        <div class="signin-wrap" style="margin-top: 15px;">
          <div class="pe_signin_button" data-client-id="17286597723145724436" data-theme="dark"></div>
        </div>
      </div>
    </section>

    <section id="dashboard" class="hidden">
      <header class="sticky-header">
        <div class="header-left" style="display:flex; align-items:center; gap:10px;">
          <button id="menuBtn" class="hamburger">‚ò∞</button>
          <img src="logo.png" alt="Logo" class="nav-logo">
        </div>
        <div class="wallets">
          <div class="pill cash-pill">Cash<strong id="cashAmount">‚Çπ0</strong></div>
          <div class="pill win-pill">Winning<strong id="winAmount">‚Çπ0</strong></div>
        </div>
      </header>

      <div class="announcement">üôè ‡§¶‡•ã‡§∏‡•ç‡§§‡•ã‡§Ç SR Ludo ‡§´‡•à‡§Æ‡§ø‡§≤‡•Ä ‡§π‡§Æ‡•á‡§∂‡§æ ‡§Ü‡§™‡§ï‡•á ‡§∏‡§æ‡§• ‡§π‡•à‡•§ üòò</div>

      <div class="game-grid">
        <div class="game-card" onclick="window.location.href='battles.html'">
          <div class="img-wrap"><img src="classic.png"></div>
          <div class="game-label">Classic Ludo</div>
        </div>
        <div class="game-card" onclick="window.location.href='https://wa.me/918982766711'">
          <div class="img-wrap" style="display:grid; place-items:center;"><img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" style="width:50%;"></div>
          <div class="game-label">Support</div>
        </div>
      </div>

      <div style="padding:15px; background:white; margin:15px; border-radius:12px; border:1px solid #e2e8f0; color:var(--text-dark); text-align:center;">
        <strong>Refer & Earn Lifetime</strong>
        <p style="font-size:11px; margin:5px 0;">Share this link to earn 2% commission:</p>
        <div id="myReferralLink" style="background:#f8fafc; padding:10px; border-radius:8px; font-size:11px; font-weight:700; border:1px dashed var(--accent); word-break: break-all;">Loading Link...</div>
      </div>

      <nav class="bottom-nav">
        <a href="#" class="nav-item active">üè†<br>Home</a>
        <a href="battles.html" class="nav-item">üéÆ<br>Battles</a>
        <a href="refer.html" class="nav-item">üéÅ<br>Refer</a>
        <a href="wallet.html" class="nav-item">üíº<br>Wallet</a>
        <a href="profile.html" class="nav-item">üë§<br>Profile</a>
      </nav>
    </section>
  </div>

  <aside id="sidebar" class="sidebar">
    <h4 style="color:white; margin-bottom:20px;">SR LUDO Menu</h4>
    <a href="#" class="menu-link" onclick="location.reload()">Home</a>
    <a href="#" class="menu-link history-link" data-type="match_history">Match History</a>
    <a href="#" class="menu-link history-link" data-type="deposit_history">Deposit History</a>
    <a href="#" class="menu-link history-link" data-type="withdraw_history">Withdraw History</a>
    <a href="wallet.html" class="menu-link">Wallet</a>
    <a href="profile.html" class="menu-link">Profile</a>
    <a href="#" class="menu-link" id="logoutBtn">Logout</a>
  </aside>

  <div id="overlay" class="overlay"></div>

  <section id="historyModal" class="modal">
    <h4 id="modalTitle" style="margin:0 0 15px 0;">History</h4>
    <div id="historyList"></div>
    <button id="closeModalBtn" style="width:100%; padding:12px; margin-top:15px; background:var(--accent); border:none; border-radius:10px; color:white; font-weight:bold;">Close</button>
  </section>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, ref, get, set, update, onValue, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

    // ‚úÖ STEP 1: Capture Referral from URL immediately
    (function captureReferral() {
      const urlParams = new URLSearchParams(window.location.search);
      const refCode = urlParams.get('ref');
      if (refCode) {
        localStorage.setItem('sr_ludo_pending_referral', refCode.trim());
        console.log("Captured Referral:", refCode);
      }
    })();

    const firebaseConfig = {
      apiKey: 'AIzaSyAx0fr47IsOtBxakcBj1ndwDYle_XlaE-Y',
      authDomain: 'sr-ludo-4440b.firebaseapp.com',
      databaseURL: 'https://sr-ludo-4440b-default-rtdb.firebaseio.com',
      projectId: 'sr-ludo-4440b',
      storageBucket: 'sr-ludo-4440b.firebasestorage.app',
      messagingSenderId: '1080387235822',
      appId: '1:1080387235822:web:77faea231641837950e8ff'
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentPhone = localStorage.getItem('sr_ludo_phone');

    // ‚úÖ CORRECTED HISTORY LOGIC
    const showHistory = async (type) => {
      if (!currentPhone) return;
      let dbPath = type;
      if (type === 'deposit_history') dbPath = 'deposit_requests';
      if (type === 'withdraw_history') dbPath = 'withdraw_requests';

      document.getElementById('modalTitle').textContent = type.replace('_', ' ').toUpperCase();
      const listDiv = document.getElementById('historyList');
      listDiv.innerHTML = 'Loading...';
      document.getElementById('historyModal').classList.add('show');
      document.getElementById('overlay').classList.add('show');

      const snap = await get(query(ref(db, `${dbPath}/${currentPhone}`), limitToLast(20)));
      const data = snap.val();
      if (!data) { listDiv.innerHTML = 'No records found.'; return; }

      listDiv.innerHTML = Object.entries(data).reverse().map(([id, item]) => {
        const st = (item.status || 'pending').toLowerCase();
        const color = st === 'success' || st === 'approved' ? 'var(--ok)' : (st === 'rejected' ? 'var(--danger)' : 'var(--warn)');
        return `<div class="record" style="border-left:4px solid ${color}">
                  <div style="display:flex; justify-content:space-between"><strong>‚Çπ${item.amount || item.entry_fee || 0}</strong> <span style="color:${color}">${st.toUpperCase()}</span></div>
                  <div style="font-size:10px; color:gray; margin-top:4px;">ID: #${id.slice(-6)}</div>
                </div>`;
      }).join('');
    };

    const processReferral = async (newUserPhone, typedCode) => {
      if (!typedCode || typedCode === newUserPhone) return;
      try {
        const codeSnap = await get(ref(db, `referral_codes/${typedCode}`));
        if (codeSnap.exists()) {
          const referrerPhone = codeSnap.val().phone;
          await update(ref(db, `users/${newUserPhone}`), { referredBy: referrerPhone });
          await set(ref(db, `referrals/${referrerPhone}/${newUserPhone}`), { phone: newUserPhone, joinedAt: Date.now() });
        }
      } catch (e) { console.error(e); }
    };

    const createUserIfMissing = async (phone) => {
      const userRef = ref(db, `users/${phone}`);
      const userSnap = await get(userRef);
      const pendingRef = localStorage.getItem('sr_ludo_pending_referral');

      if (!userSnap.exists()) {
        await set(userRef, { phone, balance: 0, win_balance: 0, kyc_status: 'pending', time: Date.now() });
        if (pendingRef) { await processReferral(phone, pendingRef); localStorage.removeItem('sr_ludo_pending_referral'); }
      }

      onValue(userRef, (s) => {
        const u = s.val() || {};
        document.getElementById('cashAmount').textContent = `‚Çπ${u.balance || 0}`;
        document.getElementById('winAmount').textContent = `‚Çπ${u.win_balance || 0}`;
        const cleanCode = phone.replace(/\D/g, '').slice(-6);
        document.getElementById('myReferralLink').textContent = `${window.location.origin}${window.location.pathname}?ref=${cleanCode}`;
      });
    };

    const checkAuth = () => {
      if (currentPhone) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        createUserIfMissing(currentPhone);
      } else {
        document.getElementById('loginScreen').classList.remove('hidden');
      }
      document.body.classList.add('ready');
    };

    document.getElementById('loginBtn').onclick = () => {
      const code = document.getElementById('referralCode').value.trim();
      if (code) localStorage.setItem('sr_ludo_pending_referral', code);
      const btn = document.querySelector('.pe_signin_button button');
      if (btn) btn.click();
    };

    window.phoneEmailListener = (userObj) => {
      let ph = userObj?.phone_no || userObj?.phone;
      if (ph) {
        let digits = ph.toString().replace(/\D/g, '');
        let final = (digits.length === 10) ? "+91" + digits : "+" + digits;
        localStorage.setItem('sr_ludo_phone', final);
        location.reload();
      }
    };

    document.getElementById('menuBtn').onclick = () => { document.getElementById('sidebar').classList.add('open'); document.getElementById('overlay').classList.add('show'); };
    document.getElementById('overlay').onclick = () => { document.getElementById('sidebar').classList.remove('open'); document.getElementById('historyModal').classList.remove('show'); document.getElementById('overlay').classList.remove('show'); };
    document.getElementById('closeModalBtn').onclick = () => { document.getElementById('historyModal').classList.remove('show'); document.getElementById('overlay').classList.remove('show'); };
    document.getElementById('logoutBtn').onclick = () => { localStorage.clear(); location.reload(); };
    document.querySelectorAll('.history-link').forEach(link => { link.onclick = (e) => { e.preventDefault(); showHistory(link.dataset.type); document.getElementById('sidebar').classList.remove('open'); }; });

    checkAuth();
  </script>
</body>
</html>
